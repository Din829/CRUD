# DifyLang 错误反馈测试案例集

**测试目标**: 验证 LLM 错误处理服务能够将技术性的 Flask/MySQL 错误转换为用户友好的信息

**测试数据库表**: users、prompts、api_tokens、ocr_tasks

---

## 一、数据约束错误测试

### 1.1 唯一约束违反 - 用户表(通过)

#### 测试案例 1.1.1: 重复用户名
- **输入**: "添加一个新用户，用户名为'张伟'，邮箱为'newzhangwei@example.com'，密码为'newpassword'"
- **预期技术错误**: `IntegrityError: (1062, "Duplicate entry '张伟' for key 'username'")`
- **期望友好反馈**: "用户名'张伟'已经存在，请选择其他用户名。"

#### 测试案例 1.1.2: 重复邮箱
- **输入**: "添加一个新用户，用户名为'新用户123'，邮箱为'q995182408@gmail.com'，密码为'password123'"
- **预期技术错误**: `IntegrityError: (1062, "Duplicate entry 'q995182408@gmail.com' for key 'email'")`
- **期望友好反馈**: "邮箱'q995182408@gmail.com'已被其他用户使用，请使用其他邮箱地址。"

### 1.2 外键约束违反（通过）

#### 测试案例 1.2.1: 不存在的用户ID - 提示词表
- **输入**: "为用户ID为999的用户添加一个提示词，标题为'测试提示'，内容为'测试内容'，分类为'测试'"
- **预期技术错误**: `IntegrityError: (1452, "Cannot add or update a child row: a foreign key constraint fails")`
- **期望友好反馈**: "用户ID 999 不存在，无法为该用户添加提示词。请检查用户ID是否正确。"

#### 测试案例 1.2.2: 不存在的用户ID - API令牌表
- **输入**: "为用户ID为888的用户添加一个OpenAI令牌，值为'sk-test123'"
- **预期技术错误**: `IntegrityError: (1452, "Cannot add or update a child row: a foreign key constraint fails")`
- **期望友好反馈**: "用户ID 888 不存在，无法为该用户添加API令牌。请检查用户ID是否正确。"

#### 测试案例 1.2.3: 不存在的用户ID - OCR任务表
- **输入**: "为用户ID为777创建一个OCR任务，任务ID为'test-task-123'，状态为'pending'"
- **预期技术错误**: `IntegrityError: (1452, "Cannot add or update a child row: a foreign key constraint fails")`
- **期望友好反馈**: "用户ID 777 不存在，无法为该用户创建OCR任务。请检查用户ID是否正确。"

### 1.3 非空约束违反(不设置字段，系统貌似会自动随机填写字段，但是"添加一个prompt，不和任何用户关联，其余字段随机"这个测试没问题，正常提示：很抱歉，您的操作未能成功。原因是必须填写“用户编号”（user_id），但目前没有提供这个信息。建议您在提交时填写完整的用户编号，再试一次。如果有疑问，可以联系管理员获取帮助。)

#### 测试案例 1.3.1: 缺少必填字段 - 用户表
- **输入**: "添加一个新用户，用户名为'测试用户'，但不设置邮箱"
- **预期技术错误**: `IntegrityError: (1048, "Column 'email' cannot be null")`
- **期望友好反馈**: "邮箱是必填字段，请提供有效的邮箱地址。"

#### 测试案例 1.3.2: 缺少必填字段 - 提示词表
- **输入**: "添加一个提示词，只设置标题为'测试'，不设置内容"
- **预期技术错误**: `IntegrityError: (1048, "Column 'content' cannot be null")`
- **期望友好反馈**: "提示词内容是必填字段，请提供提示词的具体内容。"

### 1.4 数据类型不匹配

#### 测试案例 1.4.1: 字符串传入数字字段
- **输入**: "修改用户ID为'不是数字'的用户名为'新名字'"（提示抱歉，处理您的修改请求时遇到问题：
未找到不是数字。请检查名称是否正确，或者该记录是否存在。）
- **预期技术错误**: `DataError: (1292, "Incorrect integer value: '不是数字' for column 'id'")`
- **期望友好反馈**: "用户ID必须是数字，'不是数字'不是有效的用户ID。"

#### 测试案例 1.4.2: 超长字符串
- **输入**: "添加一个用户名为'这是一个非常非常非常长的用户名，超过了数据库字段的最大长度限制，应该会导致截断错误或者长度超限错误'的用户"
- **预期技术错误**: `DataError: (1406, "Data too long for column 'username'")`
- **期望友好反馈**: "用户名过长，请使用较短的用户名（建议不超过50个字符）。"

---

## 二、SQL语法错误测试

### 2.1 表名错误

#### 测试案例 2.1.1: 不存在的表名
- **输入**: "查询所有student表的数据"（提示最终答案: ERROR: 请澄清你的查询条件，例如提供完整编号或指定具体字段。
  错误信息: 没有有效的 SQL 语句可执行。）
- **预期技术错误**: `ProgrammingError: (1146, "Table 'database.student' doesn't exist")`
- **期望友好反馈**: "表'student'不存在。当前数据库包含的表有：users（用户）、prompts（提示词）、api_tokens（API令牌）、ocr_tasks（OCR任务）。"

#### 测试案例 2.1.2: 表名拼写错误
- **输入**: "查询user表的所有数据"（少了s）（还是会自动查询到users表，不够严谨）
- **预期技术错误**: `ProgrammingError: (1146, "Table 'database.user' doesn't exist")`
- **期望友好反馈**: "表'user'不存在，您是否想查询'users'表？"

### 2.2 字段名错误（这个基本上都查到，是否需要考虑必须严谨？）

#### 测试案例 2.2.1: 不存在的字段名
- **输入**: "查询所有用户的姓名和邮箱"（实际字段是username，不是姓名/name）（这个也是都查询到了，但这个其实还好，我觉得这个可以灵活点，可以让AI查，之后再补充您是否想查询'username'字段？等）
- **预期技术错误**: `ProgrammingError: (1054, "Unknown column 'name' in 'field list'")`
- **期望友好反馈**: "字段'name'在users表中不存在。users表的可用字段包括：id、username、email、password、created_at、updated_at。您是否想查询'username'字段？"

#### 测试案例 2.2.2: 字段名拼写错误
- **输入**: "查询所有提示词的titel和内容"（title拼写错误）（还是都查到了，AI貌似能自动处理拼写错误）
- **预期技术错误**: `ProgrammingError: (1054, "Unknown column 'titel' in 'field list'")`
- **期望友好反馈**: "字段'titel'在prompts表中不存在，您是否想查询'title'字段？"

### 2.3 SQL语法错误

#### 测试案例 2.3.1: WHERE子句语法错误（正常提示根据您的查询，没有找到具体数据。）
- **输入**: "查询用户名等于张三的用户"（系统生成了语法错误的SQL）
- **预期技术错误**: `ProgrammingError: (1064, "You have an error in your SQL syntax near '=' at line 1")`
- **期望友好反馈**: "查询语句格式有误。请重新描述您的查询需求，我将为您生成正确的查询。"

---

## 三、业务逻辑错误测试

### 3.1 记录不存在错误（通过）

#### 测试案例 3.1.1: 修改不存在的用户
- **输入**: "将用户ID为999的用户名修改为'新名字'"
- **预期结果**: API返回成功但affected_rows为0
- **期望友好反馈**: "未找到ID为999的用户，无法执行修改操作。请确认用户ID是否正确。"

#### 测试案例 3.1.2: 删除不存在的提示词
- **输入**: "删除ID为888的提示词"
- **预期结果**: API返回成功但affected_rows为0
- **期望友好反馈**: "未找到ID为888的提示词，可能已被删除或ID不正确。"

### 3.2 状态冲突错误（取消）

#### 测试案例 3.2.1: 修改已完成的OCR任务（没有此类验证，这关乎应用后端逻辑，我这个只是数据库交汇）
- **输入**: "将状态为'completed'的OCR任务修改为'pending'"
- **预期**: 业务逻辑错误（如果有此类验证）
- **期望友好反馈**: "已完成的OCR任务无法修改状态为pending，请检查任务状态。"

---

## 四、复合操作错误测试(已解决)
复合路径提示词有问题：
API结果: None
执行错误: 执行操作 '复合路径' 时发生意外错误: 409 Client Error: CONFLICT for url: http://127.0.0.1:5003/execute_batch_operations
格式化执行层错误信息: 执行操作 '复合路径' 时发生意外错误: 409 Client Error: CONFLICT for url: http://127.0.0.1:5003/execute_batch_operations

--- 处理完成 ---
  最终答案: 执行操作 '复合路径' 时发生意外错误: 409 Client Error: CONFLICT for url: http://127.0.0.1:5003/execute_batch_operations
  错误信息: 执行操作 '复合路径' 时发生意外错误: 409 Client Error: CONFLICT for url: http://127.0.0.1:5003/execute_batch_operations

请输入您的问题 (或输入 '退出' 结束):

没有用户友好化


### 4.1 依赖操作失败

#### 测试案例 4.1.1: 新增用户失败导致后续操作失败
- **输入**: "创建一个用户名为'张伟'的新用户，然后为这个用户添加一个API令牌"
- **预期错误**: 第一步因用户名重复失败，第二步依赖失败
- **期望友好反馈**: "创建用户失败：用户名'张伟'已存在。因此无法为该用户添加API令牌。请更换用户名后重试。"

#### 测试案例 4.1.2: 查询依赖失败（该操作已经调整为纯新增路径,即查询+xxx都为xxx路径）
- **输入**: "为用户'不存在的用户'添加一个新提示词"
- **预期错误**: 查询用户ID失败，导致后续插入无法进行
- **期望友好反馈**: "未找到用户'不存在的用户'，无法为该用户添加提示词。请确认用户名是否正确。"

### 4.2 批量操作部分失败（通过，但提示比较含糊，并没有说明ID 999，可能flask也没说）

#### 测试案例 4.2.1: 批量插入部分失败
- **输入**: "批量添加三个API令牌：用户ID 33的OpenAI令牌、用户ID 999的Google令牌、用户ID 34的GitHub令牌"
- **预期错误**: 第二个因用户ID不存在失败，整个事务回滚
- **期望友好反馈**: "批量添加API令牌失败：用户ID 999 不存在。为保证数据一致性，所有令牌添加操作已取消。请检查用户ID后重试。"

---

## 五、网络和系统错误测试（后续再进行测试）

### 5.1 数据库连接错误

#### 测试案例 5.1.1: 数据库连接超时
- **模拟场景**: 数据库服务暂时不可用
- **预期技术错误**: `OperationalError: (2003, "Can't connect to MySQL server")`
- **期望友好反馈**: "数据库服务暂时不可用，请稍后重试。如果问题持续存在，请联系技术支持。"

### 5.2 权限错误

#### 测试案例 5.2.1: 无删除权限
- **模拟场景**: 数据库用户无删除权限
- **预期技术错误**: `ProgrammingError: (1142, "DELETE command denied to user")`
- **期望友好反馈**: "当前用户没有删除数据的权限。请联系管理员获取相应权限。"

---

## 六、特殊字符和编码错误测试

### 6.1 特殊字符处理

#### 测试案例 6.1.1: SQL注入尝试
- **输入**: "查找用户名为'; DROP TABLE users; --'的用户"
- **预期**: 参数化查询应该安全处理，但可能返回语法错误
- **期望友好反馈**: "输入包含特殊字符，请使用普通的用户名进行查询。"

-ERROR:app:Error executing query: (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''; DROP TABLE users' at line 1")
ERROR:app:MySQL syntax error detected: (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''; DROP TABLE users' at line 1")
ERROR:app:Syntax error near ''; DROP TABLE users' at line 1
INFO:werkzeug:127.0.0.1 - - [23/May/2025 06:18:10] "POST /execute_query HTTP/1.1" 500 -

该报错信息
--- 处理完成 ---
  最终答案: 执行查询时遇到错误。请澄清你的查询条件。
  错误信息: 执行 SQL 查询时出错: API错误: [1064, "SQL syntax error near ''; DROP TABLE users' at line 1"]
  AI并没正确生成反馈

#### 测试案例 6.1.2: 不支持的字符编码（emoji好像也没啥问题，正常说根据您的查询，没有找到具体数据）
- **输入**: 包含特殊emoji或罕见Unicode字符的输入
- **预期技术错误**: 编码相关错误
- **期望友好反馈**: "输入包含不支持的字符，请使用常规文字重新输入。"

---

## 七、并发和锁定错误测试（后续再进行测试）

### 7.1 并发修改冲突

#### 测试案例 7.1.1: 死锁检测
- **模拟场景**: 并发操作导致死锁
- **预期技术错误**: `OperationalError: (1213, "Deadlock found when trying to get lock")`
- **期望友好反馈**: "由于其他操作正在进行，当前请求暂时无法处理。请稍后重试。"

---

## 测试执行指南

### 测试步骤
1. **准备测试环境**: 确保数据库包含测试数据
2. **逐一执行测试案例**: 记录技术错误和友好反馈
3. **对比效果**: 验证LLM错误转换的准确性和友好程度
4. **优化提示词**: 根据测试结果调整错误处理提示词

### 评估标准
1. **准确性**: 友好信息是否准确反映了错误原因
2. **友好性**: 是否使用了非技术性的语言
3. **建议性**: 是否提供了解决问题的建议
4. **完整性**: 是否覆盖了所有重要的错误信息

### 测试记录模板
```
测试案例ID: [案例编号]
输入: [用户输入]
技术错误: [实际的Flask/MySQL错误]
友好反馈: [LLM转换后的用户友好信息]
评分: [1-5分]
- 准确性: [分数]
- 友好性: [分数]
- 建议性: [分数]
备注: [改进建议]
```

---

## 八、错误分类优先级

### 高优先级（必须优化）
- 数据约束错误（唯一约束、外键约束）
- 表名、字段名错误
- 记录不存在错误

### 中优先级（建议优化）
- 数据类型错误
- SQL语法错误
- 复合操作错误

### 低优先级（可选优化）
- 网络连接错误
- 权限错误
- 并发错误

这套测试案例可以全面验证您的LLM错误处理服务的效果，并为后续优化提供指导。 